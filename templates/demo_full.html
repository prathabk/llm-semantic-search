<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Semantic Search Demo - Interactive Demo</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">

    <!-- Prism.js for code highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.css">
    <style>
        .demo-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .demo-header {
            text-align: center;
            margin-bottom: 48px;
        }

        .demo-header h1 {
            font-size: 2.5em;
            margin-bottom: 16px;
            color: var(--text);
        }

        .demo-header .subtitle {
            font-size: 1.25em;
            color: var(--text-secondary);
        }

        .status-banner {
            padding: 12px 20px;
            border-radius: 8px;
            margin-bottom: 24px;
            display: none;
            align-items: center;
            gap: 12px;
            font-weight: 500;
        }

        .status-banner.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #10b981;
        }

        .status-banner.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #ef4444;
        }

        .status-banner.info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid var(--primary);
        }

        .demo-section {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 32px;
            margin-bottom: 32px;
            box-shadow: 0 1px 3px var(--shadow);
        }

        .demo-section h2 {
            font-size: 1.5em;
            margin-bottom: 8px;
            color: var(--text);
        }

        .demo-section .section-subtitle {
            color: var(--text-secondary);
            margin-bottom: 24px;
            font-size: 0.9375em;
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text);
        }

        .form-group textarea {
            width: 100%;
            min-height: 150px;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.9375em;
            resize: vertical;
        }

        .form-group input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 1em;
        }

        .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 1em;
            background: var(--surface);
        }

        .button-group {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--surface);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover:not(:disabled) {
            background: var(--bg);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .output-box {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
            margin-top: 16px;
            max-height: 400px;
            overflow-y: auto;
        }

        .output-box pre {
            margin: 0;
            font-size: 0.875em;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .output-box h4 {
            margin-top: 0;
            margin-bottom: 12px;
            color: var(--text);
            font-size: 1em;
        }

        .answer-box {
            background: #fef3c7;
            border: 2px solid #f59e0b;
            border-radius: 8px;
            padding: 20px;
            margin-top: 16px;
            font-size: 1.125em;
            font-weight: 500;
        }

        .answer-box .answer-label {
            color: #92400e;
            font-size: 0.875em;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 8px;
        }

        .answer-box .answer-text {
            color: #78350f;
        }

        .step-indicator {
            display: flex;
            gap: 16px;
            margin-bottom: 32px;
            padding: 20px;
            background: var(--bg);
            border-radius: 8px;
        }

        .step {
            flex: 1;
            text-align: center;
            padding: 16px;
            border-radius: 8px;
            border: 2px solid var(--border);
            transition: all 0.3s;
        }

        .step.active {
            border-color: var(--primary);
            background: var(--surface);
        }

        .step.completed {
            border-color: #10b981;
            background: #d1fae5;
        }

        .step-number {
            display: inline-block;
            width: 32px;
            height: 32px;
            line-height: 32px;
            border-radius: 50%;
            background: var(--border);
            color: var(--text-secondary);
            font-weight: bold;
            margin-bottom: 8px;
        }

        .step.active .step-number {
            background: var(--primary);
            color: white;
        }

        .step.completed .step-number {
            background: #10b981;
            color: white;
        }

        .step-label {
            font-size: 0.875em;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .step.active .step-label {
            color: var(--text);
        }

        .sample-data-btn {
            font-size: 0.875em;
            padding: 6px 12px;
            margin-top: 8px;
        }

        .info-badge {
            display: inline-block;
            padding: 4px 12px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 16px;
            font-size: 0.875em;
            color: var(--text-secondary);
            margin-left: 8px;
        }

        .json-preview {
            background: #1e293b;
            color: #e2e8f0;
            padding: 16px;
            border-radius: 8px;
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 0.875em;
            overflow-x: auto;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }

        .stat-card {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
            text-align: center;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: var(--primary);
        }

        .stat-label {
            font-size: 0.875em;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .toggle-section {
            margin-top: 16px;
            padding: 12px;
            background: var(--bg);
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .toggle-option {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }

        .toggle-option input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .toggle-option label {
            cursor: pointer;
            font-weight: 500;
            margin: 0;
            font-size: 0.9375em;
        }

        .toggle-option .description {
            color: var(--text-secondary);
            font-size: 0.8125em;
            margin-top: 2px;
        }

        .answer-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.7em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-left: 6px;
        }

        .answer-badge.generative {
            background: #dbeafe;
            color: #1e40af;
        }

        .answer-badge.static {
            background: #e5e7eb;
            color: #374151;
        }

        /* Collapsible widgets for code snippets */
        .collapsible {
            margin-top: 24px;
        }

        .collapsible-header {
            background: var(--bg);
            border: 2px solid var(--border);
            padding: 16px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }

        .collapsible-header:hover {
            border-color: var(--primary);
            background: var(--surface);
        }

        .collapsible-header h4 {
            margin: 0;
            font-size: 1.05em;
            color: var(--text);
        }

        .collapsible-arrow {
            font-size: 1.2em;
            transition: transform 0.3s;
        }

        .collapsible-header.active .collapsible-arrow {
            transform: rotate(90deg);
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .collapsible-content.active {
            max-height: 2000px;
            transition: max-height 0.5s ease-in;
        }

        .code-snippet {
            margin-top: 12px;
            border-radius: 8px;
            overflow: hidden;
        }

        .code-snippet pre {
            margin: 0;
            max-height: 500px;
            overflow-y: auto;
        }

        .code-snippet pre code {
            font-size: 0.85em;
            line-height: 1.5;
        }

        .json-output {
            margin-top: 12px;
            background: #1e293b;
            color: #e2e8f0;
            padding: 16px;
            border-radius: 8px;
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 0.85em;
            line-height: 1.6;
            max-height: 500px;
            overflow-y: auto;
        }

        /* JSON Tree Viewer Styles */
        .json-tree {
            background: #ffffff;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
            margin-top: 12px;
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 0.875em;
            max-height: 500px;
            overflow-y: auto;
        }

        .json-tree ul {
            list-style: none;
            padding-left: 24px;
            margin: 4px 0;
        }

        .json-tree > ul {
            padding-left: 0;
        }

        .json-tree li {
            margin: 4px 0;
            position: relative;
        }

        .json-key {
            color: #0066cc;
            font-weight: 600;
        }

        .json-string {
            color: #22863a;
        }

        .json-number {
            color: #005cc5;
        }

        .json-boolean {
            color: #d73a49;
        }

        .json-null {
            color: #6f42c1;
        }

        .json-toggle {
            cursor: pointer;
            user-select: none;
            display: inline-block;
            width: 16px;
            color: #6a737d;
            font-weight: bold;
        }

        .json-toggle:hover {
            color: var(--primary);
        }

        .json-collapsed > ul {
            display: none;
        }

        .json-bracket {
            color: #6a737d;
            font-weight: bold;
        }

        .json-item-count {
            color: #6a737d;
            font-size: 0.9em;
            margin-left: 6px;
        }

        .code-section {
            margin-top: 32px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
        }

        .code-section h3 {
            margin-top: 0;
            margin-bottom: 16px;
            font-size: 1.25em;
        }
    </style>
</head>
<body>
    <div class="demo-container">
        <a href="/demo" class="home-link">‚Üê Back to Demo Home</a>

        <div class="demo-header">
            <h1>üöÄ Semantic Search Demo</h1>
            <p class="subtitle">Interactive demonstration of LLM-powered semantic search with Typesense</p>
        </div>

        <div id="statusBanner" class="status-banner"></div>

        <div class="step-indicator">
            <div class="step" id="step1">
                <div class="step-number">1</div>
                <div class="step-label">Input Data</div>
            </div>
            <div class="step" id="step2">
                <div class="step-number">2</div>
                <div class="step-label">Structure with LLM</div>
            </div>
            <div class="step" id="step3">
                <div class="step-number">3</div>
                <div class="step-label">Store in DB</div>
            </div>
            <div class="step" id="step4">
                <div class="step-number">4</div>
                <div class="step-label">Query</div>
            </div>
        </div>

        <!-- Step 1: Input Data -->
        <div class="demo-section">
            <h2>Step 1: Input Unstructured Data</h2>
            <p class="section-subtitle">Enter your unstructured text data (one document per line)</p>

            <div class="form-group">
                <label for="inputData">
                    Unstructured Text Data
                    <span class="info-badge" id="lineCount">0 lines</span>
                </label>
                <textarea
                    id="inputData"
                    placeholder="Enter unstructured text, one document per line...&#10;Example:&#10;Balu is a boy. He likes blue color and curd rice.&#10;Ram is a boy. He likes red color and briyani."
                ></textarea>
                <button class="btn btn-secondary sample-data-btn" onclick="loadSampleData()">
                    Load Sample Data
                </button>
            </div>

            <div class="form-group">
                <label for="modelSelect">Select LLM Model</label>
                <select id="modelSelect">
                    <option value="gemma3:270m">Gemma 3:270M (Fastest)</option>
                    <option value="gemma3:1b" selected>Gemma 3:1B (Balanced)</option>
                    <option value="gemma3:4b">Gemma 3:4B (Most Accurate)</option>
                </select>
            </div>

            <div class="button-group">
                <button class="btn btn-primary" onclick="structureData()" id="structureBtn">
                    Structure Data with LLM ‚Üí
                </button>
            </div>

            <div id="structuredOutput" style="display: none;">
                <!-- Collapsible JSON Data -->
                <div class="collapsible" style="margin-top: 16px;">
                    <div class="collapsible-header" onclick="toggleCollapsible(this)">
                        <h4>üìÑ Structured JSON Data</h4>
                        <span class="collapsible-arrow">‚ñ∂</span>
                    </div>
                    <div class="collapsible-content">
                        <div class="json-tree" id="structuredJson"></div>
                    </div>
                </div>

                <!-- Collapsible Python Code -->
                <div class="collapsible">
                    <div class="collapsible-header" onclick="toggleCollapsible(this)">
                        <h4>üíª Python Code - Structure Data with LLM</h4>
                        <span class="collapsible-arrow">‚ñ∂</span>
                    </div>
                    <div class="collapsible-content">
                        <div class="code-snippet">
                            <pre class="line-numbers"><code class="language-python" id="structureCode"># Code will appear here after structuring</code></pre>
                        </div>
                    </div>
                </div>

                <div class="stats-grid" style="margin-top: 24px;">
                    <div class="stat-card">
                        <div class="stat-value" id="docCount">0</div>
                        <div class="stat-label">Documents Structured</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="modelUsed">-</div>
                        <div class="stat-label">Model Used</div>
                    </div>
                </div>

                <div class="button-group" style="margin-top: 16px; display: flex; gap: 12px;">
                    <button class="btn btn-primary" onclick="console.log('Clear and Store clicked'); storeInTypesense(true);" id="clearStoreBtn" style="flex: 1;">
                        üóëÔ∏è Clear and Store
                    </button>
                    <button class="btn" onclick="console.log('Append clicked'); storeInTypesense(false);" id="appendBtn" style="flex: 1; background: #10b981; color: white;" onmouseover="this.style.background='#059669'" onmouseout="this.style.background='#10b981'">
                        ‚ûï Append
                    </button>
                </div>
                <div style="margin-top: 12px; padding: 12px; background: var(--bg); border-radius: 6px; border: 1px solid var(--border); font-size: 0.875em; color: var(--text-secondary);">
                    <strong style="color: var(--text);">üí° Tip:</strong> Use <strong>Clear and Store</strong> to replace existing data or <strong>Append</strong> to add to existing data without clearing.
                </div>

                <!-- Collapsible Store Response -->
                <div class="collapsible" id="storeCodeSection" style="display: none;">
                    <div class="collapsible-header" onclick="toggleCollapsible(this)">
                        <h4>üíæ Python Code - Store in Typesense</h4>
                        <span class="collapsible-arrow">‚ñ∂</span>
                    </div>
                    <div class="collapsible-content">
                        <div class="code-snippet">
                            <pre class="line-numbers"><code class="language-python" id="storeCode"># Code will appear here after storing</code></pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 2: Query -->
        <div class="demo-section" id="querySection" style="display: none;">
            <h2>Step 2: Query Your Data</h2>
            <p class="section-subtitle">Ask questions in natural language</p>

            <div class="form-group">
                <label for="queryInput">Natural Language Query</label>
                <input
                    type="text"
                    id="queryInput"
                    placeholder="e.g., How many boys like blue color?"
                >
            </div>

            <div class="toggle-section">
                <div class="toggle-option">
                    <input type="checkbox" id="generativeToggle" checked>
                    <div>
                        <label for="generativeToggle">‚ú® Generative Output</label>
                        <div class="description">
                            Use LLM to generate context-aware answers
                        </div>
                    </div>
                </div>
            </div>

            <div class="button-group">
                <button class="btn btn-primary" onclick="executeQuery()" id="queryBtn">
                    Search ‚Üí
                </button>
                <button class="btn btn-secondary" onclick="resetDemo()">
                    Reset Demo
                </button>
            </div>

            <div id="queryOutput" style="display: none;">
                <div id="answerBox" class="answer-box" style="margin-bottom: 24px;">
                    <div class="answer-label">
                        üìä Answer
                        <span class="answer-badge" id="answerBadge">Generative</span>
                    </div>
                    <div class="answer-text" id="answerText"></div>
                </div>

                <!-- Collapsible Query Parameters -->
                <div class="collapsible">
                    <div class="collapsible-header" onclick="toggleCollapsible(this)">
                        <h4>üîß Generated Typesense Query</h4>
                        <span class="collapsible-arrow">‚ñ∂</span>
                    </div>
                    <div class="collapsible-content">
                        <div class="json-output" id="typesenseQuery"></div>
                    </div>
                </div>

                <!-- Collapsible LLM Context (only for generative) -->
                <div class="collapsible" id="llmContextSection" style="display: none;">
                    <div class="collapsible-header" onclick="toggleCollapsible(this)">
                        <h4>ü§ñ LLM Context (Prompt sent to Ollama)</h4>
                        <span class="collapsible-arrow">‚ñ∂</span>
                    </div>
                    <div class="collapsible-content">
                        <div class="code-snippet">
                            <pre style="background: #f8fafc; padding: 16px; border-radius: 8px; max-height: 500px; overflow-y: auto;"><code id="llmContext" style="color: #0f172a; white-space: pre-wrap;">Context will appear here after generative query</code></pre>
                        </div>
                    </div>
                </div>

                <!-- Collapsible Python Code -->
                <div class="collapsible">
                    <div class="collapsible-header" onclick="toggleCollapsible(this)">
                        <h4>üíª Python Code - Query Typesense</h4>
                        <span class="collapsible-arrow">‚ñ∂</span>
                    </div>
                    <div class="collapsible-content">
                        <div class="code-snippet">
                            <pre class="line-numbers"><code class="language-python" id="queryCode"># Code will appear here after querying</code></pre>
                        </div>
                    </div>
                </div>

                <!-- Collapsible Raw Response -->
                <div class="collapsible">
                    <div class="collapsible-header" onclick="toggleCollapsible(this)">
                        <h4>üìÑ Raw Typesense Response (JSON)</h4>
                        <span class="collapsible-arrow">‚ñ∂</span>
                    </div>
                    <div class="collapsible-content">
                        <div class="json-tree" id="rawResults"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Prism.js Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>

    <script>
        // State
        let structuredData = [];
        let currentModel = 'gemma3:1b';

        // Toggle collapsible sections
        function toggleCollapsible(header) {
            header.classList.toggle('active');
            const content = header.nextElementSibling;
            content.classList.toggle('active');
        }

        // JSON Tree Renderer
        function renderJsonTree(data, container) {
            container.innerHTML = '';
            const ul = document.createElement('ul');
            ul.style.paddingLeft = '0';
            const tree = createJsonTree(data);
            ul.appendChild(tree);
            container.appendChild(ul);
        }

        function createJsonTree(data, key = null) {
            const li = document.createElement('li');

            if (Array.isArray(data)) {
                // Array
                const toggle = document.createElement('span');
                toggle.className = 'json-toggle';
                toggle.textContent = '‚ñº';
                toggle.onclick = function(e) {
                    e.stopPropagation();
                    li.classList.toggle('json-collapsed');
                    toggle.textContent = li.classList.contains('json-collapsed') ? '‚ñ∂' : '‚ñº';
                };

                const label = document.createElement('span');
                if (key !== null) {
                    const keySpan = document.createElement('span');
                    keySpan.className = 'json-key';
                    keySpan.textContent = key;
                    label.appendChild(keySpan);
                    label.appendChild(document.createTextNode(': '));
                }

                const bracket = document.createElement('span');
                bracket.className = 'json-bracket';
                bracket.textContent = '[';
                label.appendChild(bracket);

                const count = document.createElement('span');
                count.className = 'json-item-count';
                count.textContent = data.length + (data.length === 1 ? ' item' : ' items');
                label.appendChild(count);

                li.appendChild(toggle);
                li.appendChild(label);

                if (data.length > 0) {
                    const ul = document.createElement('ul');
                    data.forEach((item, index) => {
                        ul.appendChild(createJsonTree(item, index));
                    });
                    li.appendChild(ul);

                    const closeBracket = document.createElement('span');
                    closeBracket.className = 'json-bracket';
                    closeBracket.textContent = ']';
                    ul.appendChild(closeBracket);
                } else {
                    const closeBracket = document.createElement('span');
                    closeBracket.className = 'json-bracket';
                    closeBracket.textContent = ']';
                    label.appendChild(closeBracket);
                }

            } else if (typeof data === 'object' && data !== null) {
                // Object
                const toggle = document.createElement('span');
                toggle.className = 'json-toggle';
                toggle.textContent = '‚ñº';
                toggle.onclick = function(e) {
                    e.stopPropagation();
                    li.classList.toggle('json-collapsed');
                    toggle.textContent = li.classList.contains('json-collapsed') ? '‚ñ∂' : '‚ñº';
                };

                const label = document.createElement('span');
                if (key !== null) {
                    const keySpan = document.createElement('span');
                    keySpan.className = 'json-key';
                    keySpan.textContent = key;
                    label.appendChild(keySpan);
                    label.appendChild(document.createTextNode(': '));
                }

                const bracket = document.createElement('span');
                bracket.className = 'json-bracket';
                bracket.textContent = '{';
                label.appendChild(bracket);

                const keys = Object.keys(data);
                const count = document.createElement('span');
                count.className = 'json-item-count';
                count.textContent = keys.length + (keys.length === 1 ? ' property' : ' properties');
                label.appendChild(count);

                li.appendChild(toggle);
                li.appendChild(label);

                if (keys.length > 0) {
                    const ul = document.createElement('ul');
                    keys.forEach((k) => {
                        ul.appendChild(createJsonTree(data[k], k));
                    });
                    li.appendChild(ul);

                    const closeBracket = document.createElement('span');
                    closeBracket.className = 'json-bracket';
                    closeBracket.textContent = '}';
                    ul.appendChild(closeBracket);
                } else {
                    const closeBracket = document.createElement('span');
                    closeBracket.className = 'json-bracket';
                    closeBracket.textContent = '}';
                    label.appendChild(closeBracket);
                }

            } else {
                // Primitive value
                const label = document.createElement('span');

                if (key !== null) {
                    const keySpan = document.createElement('span');
                    keySpan.className = 'json-key';
                    keySpan.textContent = key;
                    label.appendChild(keySpan);
                    label.appendChild(document.createTextNode(': '));
                }

                const valueSpan = document.createElement('span');
                if (typeof data === 'string') {
                    valueSpan.className = 'json-string';
                    valueSpan.textContent = '"' + data + '"';
                } else if (typeof data === 'number') {
                    valueSpan.className = 'json-number';
                    valueSpan.textContent = data;
                } else if (typeof data === 'boolean') {
                    valueSpan.className = 'json-boolean';
                    valueSpan.textContent = data;
                } else if (data === null) {
                    valueSpan.className = 'json-null';
                    valueSpan.textContent = 'null';
                }
                label.appendChild(valueSpan);

                li.appendChild(label);
            }

            return li;
        }

        // Update line count
        document.getElementById('inputData').addEventListener('input', (e) => {
            const lines = e.target.value.split('\n').filter(line => line.trim()).length;
            document.getElementById('lineCount').textContent = `${lines} lines`;
        });

        // Load sample data
        function loadSampleData() {
            const sampleData = `Ravi is a boy. He likes blue color and sambar rice.
He like red color and his name is Shantanu, but he always eats dhal rice.
Revathy is a girl. She likes red color and chicken bryani.
Himanshu is a boy. He likes green color and roti and dhal.
Kaushal sometimes eats curd rice but most of the time he prefers briyani while eating he always wears yellow dress.
Fayas likes mutton biryani and he like yellow color
Vishwa is a boy. He likes orange color and curd rice.
Shruthi doesn't like curd rice but prefers omelette however she likes white color
Nirnajn is fan of chicken biryaani and a blue color fan`;

            document.getElementById('inputData').value = sampleData;
            document.getElementById('lineCount').textContent = '9 lines';
            showStatus('Sample data loaded!', 'success');
        }

        // Structure data with LLM
        async function structureData() {
            const inputData = document.getElementById('inputData').value;
            const model = document.getElementById('modelSelect').value;
            currentModel = model;

            if (!inputData.trim()) {
                showStatus('Please enter some data first', 'error');
                return;
            }

            const lines = inputData.split('\n').filter(line => line.trim());

            setLoading('structureBtn', true);
            updateStep(2, 'active');

            try {
                const response = await fetch('/api/structure', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ texts: lines, model: model })
                });

                const result = await response.json();

                if (result.success) {
                    structuredData = result.data;

                    // Display JSON data as tree
                    const jsonContainer = document.getElementById('structuredJson');
                    renderJsonTree(result.data, jsonContainer);

                    // Generate and display Python code
                    const inputLines = lines.map(l => l.replace(/'/g, "\\'")).join("',\n    '");
                    const structureCodeSnippet = `# Structure unstructured data using LLM
import requests

# Unstructured text data
texts = [
    '${inputLines}'
]

# API endpoint
url = 'http://localhost:9010/api/structure'

# Request payload
payload = {
    'texts': texts,
    'model': '${model}'
}

# Send request to structure data
response = requests.post(url, json=payload)
result = response.json()

if result['success']:
    structured_data = result['data']
    print(f"Structured {result['count']} documents")
    print("Sample document:", structured_data[0])
else:
    print(f"Error: {result['error']}")`;

                    document.getElementById('structureCode').textContent = structureCodeSnippet;
                    Prism.highlightElement(document.getElementById('structureCode'));

                    document.getElementById('docCount').textContent = result.count;
                    document.getElementById('modelUsed').textContent = model.split(':')[1];
                    document.getElementById('structuredOutput').style.display = 'block';

                    updateStep(2, 'completed');
                    showStatus(`Successfully structured ${result.count} documents!`, 'success');
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
                updateStep(2, '');
            } finally {
                setLoading('structureBtn', false);
            }
        }

        // Store in Typesense
        async function storeInTypesense(recreate = true) {
            console.log('storeInTypesense called, recreate:', recreate);
            console.log('structuredData:', structuredData);

            if (!structuredData || structuredData.length === 0) {
                showStatus('No data to store. Please structure data first.', 'error');
                console.error('No structured data available');
                return;
            }

            const buttonId = recreate ? 'clearStoreBtn' : 'appendBtn';
            console.log('Button ID:', buttonId);

            setLoading(buttonId, true);
            updateStep(3, 'active');

            try {
                console.log('Sending request to /api/store');
                const response = await fetch('/api/store', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        documents: structuredData,
                        recreate: recreate
                    })
                });

                console.log('Response status:', response.status);
                const result = await response.json();
                console.log('Result:', result);

                if (result.success) {
                    updateStep(3, 'completed');
                    updateStep(4, 'active');
                    const action = recreate ? 'Cleared and stored' : 'Appended';
                    showStatus(`${action} ${result.inserted} documents in Typesense!`, 'success');

                    // Generate and display Python code for storing
                    const storeCodeSnippet = `# Store structured data in Typesense
import requests
import json

# Structured data from previous step
documents = ${JSON.stringify(structuredData, null, 4)}

# API endpoint
url = 'http://localhost:9010/api/store'

# Request payload
payload = {
    'documents': documents,
    'recreate': ${recreate}  # ${recreate ? 'Clear & Store mode' : 'Append mode'}
}

# Send request to store data
response = requests.post(url, json=payload)
result = response.json()

if result['success']:
    print(f"Stored {result['inserted']} documents in collection '{result['collection']}'")
else:
    print(f"Error: {result['error']}")`;

                    document.getElementById('storeCode').textContent = storeCodeSnippet;
                    Prism.highlightElement(document.getElementById('storeCode'));
                    document.getElementById('storeCodeSection').style.display = 'block';

                    document.getElementById('querySection').style.display = 'block';
                    document.getElementById('querySection').scrollIntoView({ behavior: 'smooth' });
                } else {
                    showStatus(`Error: ${result.error || 'Unknown error'}`, 'error');
                    console.error('Store failed:', result.error);
                }
            } catch (error) {
                console.error('Store error:', error);
                showStatus(`Error storing data: ${error.message}`, 'error');
                updateStep(3, '');
            } finally {
                setLoading(buttonId, false);
            }
        }

        // Execute query
        async function executeQuery() {
            const query = document.getElementById('queryInput').value;
            const generative = document.getElementById('generativeToggle').checked;

            if (!query.trim()) {
                showStatus('Please enter a query', 'error');
                return;
            }

            setLoading('queryBtn', true);

            try {
                const response = await fetch('/api/query', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        query: query,
                        model: currentModel,
                        generative: generative
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // Update answer badge
                    const badge = document.getElementById('answerBadge');
                    if (result.generative) {
                        badge.textContent = 'Generative';
                        badge.className = 'answer-badge generative';
                    } else {
                        badge.textContent = 'Static';
                        badge.className = 'answer-badge static';
                    }

                    // Show answer
                    document.getElementById('answerText').textContent = result.answer;

                    // Show Typesense query (formatted JSON)
                    const filterQuery = {
                        q: result.typesense_params.q,
                        filter_by: result.typesense_params.filter_by || '(none)'
                    };
                    document.getElementById('typesenseQuery').textContent =
                        JSON.stringify(filterQuery, null, 2);

                    // Show LLM context if available (for generative queries)
                    if (result.llm_context) {
                        document.getElementById('llmContext').textContent = result.llm_context;
                        document.getElementById('llmContextSection').style.display = 'block';
                    } else {
                        document.getElementById('llmContextSection').style.display = 'none';
                    }

                    // Generate and display Python code for querying
                    const queryCodeSnippet = `# Query Typesense with natural language
import requests

# Natural language query
query = "${query}"
model = "${currentModel}"
generative = ${generative}  # ${generative ? 'Use LLM for answer generation' : 'Static answer format'}

# API endpoint
url = 'http://localhost:9010/api/query'

# Request payload
payload = {
    'query': query,
    'model': model,
    'generative': generative
}

# Send query request
response = requests.post(url, json=payload)
result = response.json()

if result['success']:
    print(f"Answer: {result['answer']}")
    print(f"Found: {result['found']} documents")
    print(f"Query translated to: {result['typesense_params']}")
else:
    print(f"Error: {result['error']}")`;

                    document.getElementById('queryCode').textContent = queryCodeSnippet;
                    Prism.highlightElement(document.getElementById('queryCode'));

                    // Show raw results as tree structure
                    const rawResultsContainer = document.getElementById('rawResults');
                    renderJsonTree(result.results, rawResultsContainer);

                    document.getElementById('queryOutput').style.display = 'block';
                    updateStep(4, 'completed');
                    showStatus('Query executed successfully!', 'success');
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
            } finally {
                setLoading('queryBtn', false);
            }
        }

        // Reset demo
        function resetDemo() {
            structuredData = [];
            document.getElementById('inputData').value = '';
            document.getElementById('lineCount').textContent = '0 lines';
            document.getElementById('queryInput').value = '';
            document.getElementById('structuredOutput').style.display = 'none';
            document.getElementById('querySection').style.display = 'none';
            document.getElementById('queryOutput').style.display = 'none';

            // Reset steps
            for (let i = 1; i <= 4; i++) {
                updateStep(i, '');
            }
            updateStep(1, 'active');

            showStatus('Demo reset', 'info');
        }

        // Utility functions
        function showStatus(message, type) {
            const banner = document.getElementById('statusBanner');
            banner.textContent = message;
            banner.className = `status-banner ${type}`;
            banner.style.display = 'flex';

            setTimeout(() => {
                banner.style.display = 'none';
            }, 5000);
        }

        function setLoading(btnId, isLoading) {
            const btn = document.getElementById(btnId);

            if (isLoading) {
                // Store original text before changing it
                btn.setAttribute('data-original-text', btn.textContent);
                btn.disabled = true;
                btn.innerHTML = '<span class="loading-spinner"></span>Processing...';
            } else {
                btn.disabled = false;
                // Restore original text
                const originalText = btn.getAttribute('data-original-text') || btn.textContent;
                btn.textContent = originalText;
            }
        }

        function updateStep(stepNum, state) {
            const step = document.getElementById(`step${stepNum}`);
            step.className = 'step';
            if (state) {
                step.classList.add(state);
            }
        }

        // Initialize
        updateStep(1, 'active');

        // Health check removed - validation now happens only on action
    </script>
</body>
</html>
