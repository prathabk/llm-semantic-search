<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Typesense Similarity Search Demo - Ollama Embedding Models</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">

    <!-- Prism.js for code highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.css">

    <style>
        .demo-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .action-btn.secondary {
            background: white;
            color: var(--primary);
            border: 2px solid var(--primary);
        }

        .action-btn.secondary:hover:not(:disabled) {
            background: var(--bg);
            color: var(--primary-dark);
            border-color: var(--primary-dark);
        }

        .section {
            background: var(--surface);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .section-icon {
            font-size: 1.5em;
        }

        .section-title {
            margin: 0;
            font-size: 1.375em;
            color: var(--text);
        }

        textarea {
            width: 100%;
            min-height: 200px;
            padding: 16px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-family: -apple-system, BlinkMacSystemFont, 'Inter', sans-serif;
            font-size: 1em;
            line-height: 1.6;
            resize: vertical;
            margin-bottom: 16px;
        }

        textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        .input-group {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
        }

        .input-group input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 1em;
        }

        .input-group input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .action-btn {
            padding: 12px 24px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .action-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .action-btn:disabled {
            background: #cbd5e1;
            cursor: not-allowed;
            transform: none;
        }

        .action-btn.secondary {
            background: var(--surface);
            color: var(--text);
            border: 2px solid var(--border);
        }

        .action-btn.secondary:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: var(--bg);
        }

        .status-message {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            display: none;
        }

        .status-message.success {
            background: #d1fae5;
            color: #065f46;
            border: 2px solid #10b981;
            display: block;
        }

        .status-message.error {
            background: #fee2e2;
            color: #991b1b;
            border: 2px solid #dc2626;
            display: block;
        }

        .status-message.info {
            background: #dbeafe;
            color: #1e40af;
            border: 2px solid #2563eb;
            display: block;
        }

        .results-container {
            margin-top: 24px;
        }

        .result-card {
            background: var(--bg);
            border: 2px solid var(--border);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            transition: all 0.3s;
        }

        .result-card:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 12px var(--shadow);
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .result-rank {
            background: var(--primary);
            color: white;
            padding: 4px 12px;
            border-radius: 16px;
            font-weight: 700;
            font-size: 0.9em;
        }

        .result-score {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            color: #92400e;
            padding: 6px 14px;
            border-radius: 8px;
            font-weight: 700;
            font-size: 1em;
        }

        .result-text {
            font-size: 1.05em;
            line-height: 1.6;
            color: var(--text);
        }

        .collapsible {
            margin-top: 24px;
        }

        .collapsible-header {
            background: var(--bg);
            border: 2px solid var(--border);
            padding: 16px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }

        .collapsible-header:hover {
            border-color: var(--primary);
            background: var(--surface);
        }

        .collapsible-header h4 {
            margin: 0;
            font-size: 1.1em;
            color: var(--text);
        }

        .collapsible-arrow {
            font-size: 1.2em;
            transition: transform 0.3s;
        }

        .collapsible-header.active .collapsible-arrow {
            transform: rotate(90deg);
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .collapsible-content.active {
            max-height: 2000px;
            transition: max-height 0.5s ease-in;
        }

        .code-snippet {
            margin-top: 12px;
            border-radius: 8px;
            overflow: hidden;
        }

        .code-snippet pre {
            margin: 0;
            max-height: 400px;
            overflow-y: auto;
        }

        .code-snippet pre code {
            font-size: 0.85em;
            line-height: 1.5;
        }

        .json-output {
            margin-top: 12px;
            background: #1e293b;
            color: #e2e8f0;
            padding: 16px;
            border-radius: 8px;
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 0.85em;
            line-height: 1.6;
            max-height: 400px;
            overflow-y: auto;
        }

        .helper-text {
            font-size: 0.9em;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--bg);
            border: 2px solid var(--border);
            border-radius: 8px;
            padding: 16px;
            text-align: center;
        }

        .stat-value {
            font-size: 2em;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 0.9em;
            color: var(--text-secondary);
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="demo-container">
        <a href="/demo" class="home-link">‚Üê Back to Demos</a>

        <header style="text-align: center; margin-bottom: 48px;">
            <h1>ü§ñ Typesense Similarity Search - Ollama Embedding Models</h1>
            <p class="subtitle">
                Semantic search with <strong>explicit embeddings</strong> generated via Ollama embedding models
            </p>
            <p style="color: var(--text-secondary); font-size: 0.9em; margin-top: 8px;">
                Collection: <code style="background: var(--bg); padding: 4px 8px; border-radius: 4px;">llm_semsim_gemma</code>
                ‚Ä¢ Choose your embedding model for vector generation
            </p>
        </header>

        <!-- Stats -->
        <div class="stats-grid" id="statsGrid" style="display: none;">
            <div class="stat-card">
                <div class="stat-value" id="docCount">0</div>
                <div class="stat-label">Total Documents in Collection</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="searchCount">0</div>
                <div class="stat-label">Searches Performed</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="avgScore">-</div>
                <div class="stat-label">Avg Similarity Score</div>
            </div>
        </div>

        <!-- Debug: List All Documents -->
        <div style="text-align: center; margin-bottom: 24px;" id="debugSection">
            <button class="action-btn secondary" onclick="listAllDocuments()" style="font-size: 0.9em;">
                üîç View All Indexed Documents
            </button>
        </div>

        <!-- All Documents Display -->
        <div class="section" id="allDocsSection" style="display: none;">
            <div class="section-header">
                <span class="section-icon">üìã</span>
                <h2 class="section-title">All Documents in Collection</h2>
            </div>
            <div id="allDocsList"></div>
        </div>

        <!-- Index Documents Section -->
        <div class="section">
            <div class="section-header">
                <span class="section-icon">üìù</span>
                <h2 class="section-title">Step 1: Index Documents</h2>
            </div>

            <!-- Model Selection -->
            <div style="margin-bottom: 20px; padding: 16px; background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); border-radius: 8px; border: 2px solid var(--primary);">
                <div style="font-weight: 600; margin-bottom: 12px; color: var(--text); font-size: 1.05em;">
                    ü§ñ Select Ollama Embedding Model:
                </div>
                <select id="modelSelect" style="width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 8px; font-size: 1em; cursor: pointer; background: white;">
                    <option value="nomic-embed-text" selected>nomic-embed-text - Fast, efficient (recommended)</option>
                    <option value="embeddinggemma">embeddinggemma - Google's embedding model</option>
                    <option value="qwen3-embedding">qwen3-embedding - Qwen embedding model</option>
                </select>
                <p style="margin-top: 12px; font-size: 0.9em; color: var(--text-secondary);">
                    <strong>Important:</strong> The same model will be used for both indexing and searching.
                    Different models produce different embedding dimensions and quality.
                </p>
            </div>

            <div class="helper-text">
                Enter your documents below, one per line. Each line will be treated as a separate document.
            </div>

            <div style="margin-bottom: 12px; display: flex; gap: 8px; flex-wrap: wrap;">
                <button class="action-btn secondary" onclick="loadSampleData('technology')" style="font-size: 0.85em; padding: 8px 16px;">
                    üíª Technology Samples
                </button>
                <button class="action-btn secondary" onclick="loadSampleData('food')" style="font-size: 0.85em; padding: 8px 16px;">
                    üçΩÔ∏è Food & Preferences
                </button>
                <button class="action-btn secondary" onclick="loadSampleData('travel')" style="font-size: 0.85em; padding: 8px 16px;">
                    ‚úàÔ∏è Travel & Cities
                </button>
                <button class="action-btn secondary" onclick="loadSampleData('mixed')" style="font-size: 0.85em; padding: 8px 16px;">
                    üéØ Mixed Dataset (Recommended)
                </button>
            </div>

            <textarea id="documentsInput" placeholder="Enter documents here, one per line. For example:
Puducherry is a union territory of India.
The city has a distinctive French colonial heritage.
Mumbai is the financial capital of India.
Python is a popular programming language.
Machine learning is a subset of artificial intelligence."></textarea>

            <div style="margin: 16px 0; padding: 16px; background: var(--bg); border-radius: 8px; border: 2px solid var(--border);">
                <div style="font-weight: 600; margin-bottom: 12px; color: var(--text);">Storage Mode:</div>
                <div style="display: flex; gap: 24px;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 0.95em;">
                        <input type="radio" name="storageMode" value="clear" checked style="cursor: pointer;">
                        <span>
                            <strong>Clear & Store</strong>
                            <span style="color: var(--text-secondary); display: block; font-size: 0.9em; margin-left: 24px;">
                                Delete existing documents and create fresh collection
                            </span>
                        </span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 0.95em;">
                        <input type="radio" name="storageMode" value="append" style="cursor: pointer;">
                        <span>
                            <strong>Append</strong>
                            <span style="color: var(--text-secondary); display: block; font-size: 0.9em; margin-left: 24px;">
                                Add new documents to existing collection
                            </span>
                        </span>
                    </label>
                </div>
            </div>

            <div id="indexStatus" class="status-message"></div>

            <button class="action-btn" id="indexBtn" onclick="indexDocuments()">
                <span id="indexBtnText">üöÄ Index Documents</span>
            </button>
        </div>

        <!-- Search Section -->
        <div class="section">
            <div class="section-header">
                <span class="section-icon">üîç</span>
                <h2 class="section-title">Step 2: Search Documents</h2>
            </div>

            <div class="helper-text">
                Enter your search query to find similar documents
            </div>

            <div style="margin-bottom: 12px;">
                <button class="action-btn secondary" onclick="showSampleQueries()" style="font-size: 0.85em; padding: 8px 16px;">
                    üí° Show Sample Queries
                </button>
            </div>

            <!-- Sample Queries Display -->
            <div id="sampleQueriesSection" style="display: none; margin-bottom: 16px; padding: 16px; background: #fef3c7; border: 2px solid #fbbf24; border-radius: 8px;">
                <h4 style="margin: 0 0 12px 0; color: var(--text);">üìù Try These Sample Queries:</h4>
                <div id="sampleQueriesList" style="display: flex; flex-direction: column; gap: 8px;"></div>
            </div>

            <div class="input-group">
                <input type="text" id="queryInput" placeholder="Enter your search query..." />
                <button class="action-btn" id="searchBtn" onclick="searchDocuments()">
                    <span id="searchBtnText">Search</span>
                </button>
            </div>

            <div id="searchStatus" class="status-message"></div>

            <!-- Results -->
            <div id="resultsContainer" class="results-container" style="display: none;">
                <h3 style="margin-bottom: 16px;">Top 5 Similar Documents</h3>
                <div id="resultsList"></div>
            </div>
        </div>

        <!-- Code Snippets Section -->
        <div class="section">
            <div class="section-header">
                <span class="section-icon">üíª</span>
                <h2 class="section-title">Code Snippets & Raw Output</h2>
            </div>

            <!-- Insert Documents Code -->
            <div class="collapsible">
                <div class="collapsible-header" onclick="toggleCollapsible(this)">
                    <h4>üì• Insert Documents - Python Code</h4>
                    <span class="collapsible-arrow">‚ñ∂</span>
                </div>
                <div class="collapsible-content">
                    <div class="code-snippet">
                        <pre class="line-numbers"><code class="language-python" id="insertCode"># Code will appear here after indexing</code></pre>
                    </div>
                </div>
            </div>

            <!-- Search Query Code -->
            <div class="collapsible">
                <div class="collapsible-header" onclick="toggleCollapsible(this)">
                    <h4>üîé Search Query - Python Code</h4>
                    <span class="collapsible-arrow">‚ñ∂</span>
                </div>
                <div class="collapsible-content">
                    <div class="code-snippet">
                        <pre class="line-numbers"><code class="language-python" id="searchCode"># Code will appear here after searching</code></pre>
                    </div>
                </div>
            </div>

            <!-- Raw JSON Output -->
            <div class="collapsible">
                <div class="collapsible-header" onclick="toggleCollapsible(this)">
                    <h4>üìÑ Raw JSON Response</h4>
                    <span class="collapsible-arrow">‚ñ∂</span>
                </div>
                <div class="collapsible-content">
                    <div class="json-output" id="jsonOutput">
                        // JSON response will appear here after searching
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Prism.js Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>

    <script>
        let searchCounter = 0;
        let lastScores = [];
        let currentModel = 'nomic-embed-text';
        let currentDataset = null;

        // Sample datasets
        const SAMPLE_DATA = {
            technology: {
                docs: [
                    "Python is a high-level programming language used for web development and data science.",
                    "JavaScript is the language of the web, running in browsers and on servers with Node.js.",
                    "Machine learning algorithms learn patterns from data to make predictions.",
                    "Artificial intelligence enables computers to perform tasks that typically require human intelligence.",
                    "React is a JavaScript library for building user interfaces with reusable components.",
                    "Docker containers package applications with all their dependencies for consistent deployment.",
                    "Kubernetes orchestrates containerized applications across clusters of machines.",
                    "Neural networks are computing systems inspired by biological neural networks in the brain.",
                    "Cloud computing delivers computing services over the internet on-demand.",
                    "Git is a distributed version control system for tracking changes in source code."
                ],
                queries: [
                    { q: "coding language for websites", expected: "JavaScript, Python" },
                    { q: "AI and learning from data", expected: "Machine learning, AI" },
                    { q: "managing containers in production", expected: "Kubernetes, Docker" },
                    { q: "brain-inspired computing", expected: "Neural networks" },
                    { q: "building web interfaces", expected: "React, JavaScript" }
                ]
            },
            food: {
                docs: [
                    "Ravi loves spicy chicken biryani with extra red chili powder.",
                    "Priya is a vegetarian who enjoys paneer tikka and dal makhani.",
                    "Sanjay prefers South Indian breakfast like idli, dosa, and sambar.",
                    "Meera has a sweet tooth and loves gulab jamun and jalebi.",
                    "Arjun is health-conscious and eats grilled fish with steamed vegetables.",
                    "Kavya enjoys Italian cuisine, especially pasta carbonara and margherita pizza.",
                    "Rahul likes street food, particularly pani puri and vada pav.",
                    "Ananya follows a vegan diet with lots of fruits, nuts, and plant-based proteins.",
                    "Vikram is a meat lover who enjoys tandoori chicken and lamb kebabs.",
                    "Divya prefers Chinese food like fried rice, noodles, and manchurian."
                ],
                queries: [
                    { q: "Who likes spicy Indian rice dish?", expected: "Ravi (biryani)" },
                    { q: "vegetarian Indian food lover", expected: "Priya (paneer, dal)" },
                    { q: "South Indian breakfast enthusiast", expected: "Sanjay (idli, dosa)" },
                    { q: "sweet desserts fan", expected: "Meera (gulab jamun)" },
                    { q: "fitness-oriented healthy eater", expected: "Arjun (grilled fish)" }
                ]
            },
            travel: {
                docs: [
                    "Paris is known for the Eiffel Tower, Louvre Museum, and romantic ambiance.",
                    "Tokyo blends ancient temples with modern technology and bustling city life.",
                    "New York City is a global hub for finance, culture, and entertainment.",
                    "Bali offers tropical beaches, rice terraces, and spiritual Hindu temples.",
                    "London features historic landmarks like Big Ben, Tower Bridge, and Buckingham Palace.",
                    "Dubai showcases futuristic architecture, luxury shopping, and desert adventures.",
                    "Rome is filled with ancient ruins, including the Colosseum and Roman Forum.",
                    "Barcelona combines Gothic architecture with Gaud√≠'s modernist masterpieces.",
                    "Mumbai is India's financial capital with Bollywood, street food, and colonial buildings.",
                    "Sydney has the iconic Opera House, beautiful harbor, and stunning beaches."
                ],
                queries: [
                    { q: "romantic European city with famous tower", expected: "Paris" },
                    { q: "ancient Roman historical sites", expected: "Rome" },
                    { q: "tropical island paradise with temples", expected: "Bali" },
                    { q: "modern Asian metropolis with technology", expected: "Tokyo" },
                    { q: "Indian city with Bollywood and finance", expected: "Mumbai" }
                ]
            },
            mixed: {
                docs: [
                    "Python is a popular programming language used for artificial intelligence and machine learning.",
                    "Machine learning algorithms can predict customer behavior and recommend products.",
                    "Ravi enjoys spicy biryani and works as a software engineer building web applications.",
                    "Paris is famous for its cuisine, including croissants, escargot, and fine wines.",
                    "The Taj Mahal in Agra is a white marble mausoleum built by Emperor Shah Jahan.",
                    "Electric vehicles are becoming more popular as battery technology improves.",
                    "Yoga and meditation help reduce stress and improve mental clarity.",
                    "Shakespeare wrote 37 plays including Hamlet, Macbeth, and Romeo and Juliet.",
                    "Solar panels convert sunlight into electricity for homes and businesses.",
                    "The Great Barrier Reef is the world's largest coral reef system off Australia's coast.",
                    "Blockchain technology enables secure, decentralized transactions without intermediaries.",
                    "Mount Everest is the highest mountain in the world at 8,849 meters above sea level.",
                    "Basketball was invented by James Naismith in 1891 in Springfield, Massachusetts.",
                    "Photosynthesis is the process plants use to convert sunlight into chemical energy.",
                    "The Renaissance period marked a revival of art, culture, and learning in Europe."
                ],
                queries: [
                    { q: "AI and coding language", expected: "Python, Machine learning" },
                    { q: "Indian historical monument", expected: "Taj Mahal" },
                    { q: "renewable energy from sun", expected: "Solar panels" },
                    { q: "mental health and relaxation", expected: "Yoga and meditation" },
                    { q: "cryptocurrency technology", expected: "Blockchain" },
                    { q: "coral ecosystem in ocean", expected: "Great Barrier Reef" },
                    { q: "highest peak on Earth", expected: "Mount Everest" },
                    { q: "plants making food from light", expected: "Photosynthesis" }
                ]
            }
        };

        // Track model changes
        document.addEventListener('DOMContentLoaded', function() {
            const modelSelect = document.getElementById('modelSelect');
            modelSelect.addEventListener('change', function() {
                currentModel = this.value;
            });
        });

        function loadSampleData(dataset) {
            if (SAMPLE_DATA[dataset]) {
                currentDataset = dataset;
                document.getElementById('documentsInput').value = SAMPLE_DATA[dataset].docs.join('\n');

                // Show notification
                const statusEl = document.getElementById('indexStatus');
                statusEl.textContent = `‚úÖ Loaded ${SAMPLE_DATA[dataset].docs.length} sample documents for "${dataset}" dataset`;
                statusEl.className = 'status-message info';
                statusEl.style.display = 'block';

                setTimeout(() => {
                    statusEl.style.display = 'none';
                }, 3000);
            }
        }

        function showSampleQueries() {
            if (!currentDataset || !SAMPLE_DATA[currentDataset]) {
                alert('Please load a sample dataset first by clicking one of the sample data buttons above.');
                return;
            }

            const section = document.getElementById('sampleQueriesSection');
            const list = document.getElementById('sampleQueriesList');

            const queries = SAMPLE_DATA[currentDataset].queries;

            list.innerHTML = queries.map((item, index) => `
                <div style="display: flex; align-items: center; gap: 12px; padding: 10px; background: white; border-radius: 6px; border: 1px solid #e5e7eb;">
                    <span style="min-width: 30px; font-weight: 700; color: var(--primary);">${index + 1}.</span>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; margin-bottom: 4px;">"${item.q}"</div>
                        <div style="font-size: 0.85em; color: var(--text-secondary);">
                            Expected: ${item.expected}
                        </div>
                    </div>
                    <button class="action-btn" style="padding: 6px 12px; font-size: 0.85em;" onclick="useQuery('${item.q.replace(/'/g, "\\'")}')">
                        Try It
                    </button>
                </div>
            `).join('');

            section.style.display = 'block';
            section.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function useQuery(query) {
            document.getElementById('queryInput').value = query;
            document.getElementById('queryInput').focus();
        }

        function toggleCollapsible(header) {
            header.classList.toggle('active');
            const content = header.nextElementSibling;
            content.classList.toggle('active');
        }

        function showStatus(elementId, message, type) {
            const statusEl = document.getElementById(elementId);
            statusEl.textContent = message;
            statusEl.className = 'status-message ' + type;
            setTimeout(() => {
                if (type !== 'error') {
                    statusEl.style.display = 'none';
                }
            }, 5000);
        }

        async function indexDocuments() {
            const input = document.getElementById('documentsInput').value.trim();

            if (!input) {
                showStatus('indexStatus', 'Please enter at least one document', 'error');
                return;
            }

            const documents = input.split('\n').filter(line => line.trim());

            if (documents.length === 0) {
                showStatus('indexStatus', 'Please enter at least one document', 'error');
                return;
            }

            // Get selected storage mode and model
            const mode = document.querySelector('input[name="storageMode"]:checked').value;
            const model = document.getElementById('modelSelect').value;
            currentModel = model; // Store for search

            const btn = document.getElementById('indexBtn');
            const btnText = document.getElementById('indexBtnText');
            btn.disabled = true;
            btnText.innerHTML = '<span class="spinner"></span> Generating embeddings with ' + model + '...';

            try {
                const response = await fetch('/api/typesense-gemma/index', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ documents, mode, model })
                });

                const data = await response.json();

                if (data.success) {
                    const modeText = mode === 'clear' ? 'Cleared and indexed' : 'Appended';
                    showStatus('indexStatus', `‚úÖ ${modeText} ${data.count} documents using ${data.model}! Total: ${data.total_docs} (Embedding dim: ${data.embedding_dim})`, 'success');
                    document.getElementById('docCount').textContent = data.total_docs;
                    document.getElementById('statsGrid').style.display = 'grid';

                    // Update insert code snippet
                    updateInsertCode(documents, data.code);
                } else {
                    showStatus('indexStatus', `‚ùå Error: ${data.error}`, 'error');
                }
            } catch (error) {
                showStatus('indexStatus', `‚ùå Error: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btnText.textContent = 'üöÄ Index Documents';
            }
        }

        async function searchDocuments() {
            const query = document.getElementById('queryInput').value.trim();

            if (!query) {
                showStatus('searchStatus', 'Please enter a search query', 'error');
                return;
            }

            // Use the same model that was used for indexing
            const model = currentModel;

            const btn = document.getElementById('searchBtn');
            const btnText = document.getElementById('searchBtnText');
            btn.disabled = true;
            btnText.innerHTML = '<span class="spinner"></span> Searching with ' + model + '...';

            try {
                const response = await fetch('/api/typesense-gemma/search', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query, model })
                });

                const data = await response.json();

                if (data.success) {
                    displayResults(data.results, query, data.model);
                    updateSearchCode(query, data.code);
                    updateJsonOutput(data.raw_response);

                    // Update stats
                    searchCounter++;
                    document.getElementById('searchCount').textContent = searchCounter;

                    if (data.results.length > 0) {
                        lastScores = data.results.map(r => r.score);
                        const avgScore = (lastScores.reduce((a, b) => a + b, 0) / lastScores.length).toFixed(2);
                        document.getElementById('avgScore').textContent = avgScore;
                    }
                } else {
                    showStatus('searchStatus', `‚ùå Error: ${data.error}`, 'error');
                }
            } catch (error) {
                showStatus('searchStatus', `‚ùå Error: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btnText.textContent = 'Search';
            }
        }

        function displayResults(results, query, model) {
            const container = document.getElementById('resultsContainer');
            const list = document.getElementById('resultsList');

            if (results.length === 0) {
                showStatus('searchStatus', 'No results found', 'info');
                container.style.display = 'none';
                return;
            }

            showStatus('searchStatus', `Found ${results.length} similar documents using ${model}`, 'success');
            container.style.display = 'block';

            list.innerHTML = results.map((result, index) => `
                <div class="result-card">
                    <div class="result-header">
                        <span class="result-rank">#${index + 1}</span>
                        <span class="result-score">Similarity: ${result.score.toFixed(3)}</span>
                    </div>
                    <div class="result-text">${result.text}</div>
                    <div style="margin-top: 8px; font-size: 0.85em; color: var(--text-secondary);">
                        Distance: ${result.distance.toFixed(4)}
                    </div>
                </div>
            `).join('');
        }

        function updateInsertCode(documents, codeSnippet) {
            const code = codeSnippet || `# Insert documents into Typesense
import requests

documents = ${JSON.stringify(documents, null, 2)}

# Create documents with embeddings
docs_with_embeddings = []
for i, text in enumerate(documents):
    docs_with_embeddings.append({
        'id': str(i + 1),
        'text': text,
        'embedding': generate_embedding(text)  # Your embedding function
    })

# Index in Typesense
response = requests.post(
    'http://localhost:8108/collections/typesense-demo/documents/import',
    headers={'X-TYPESENSE-API-KEY': 'your-api-key'},
    json=docs_with_embeddings
)

print(f"Indexed {len(documents)} documents")`;

            document.getElementById('insertCode').textContent = code;
            Prism.highlightElement(document.getElementById('insertCode'));
        }

        function updateSearchCode(query, codeSnippet) {
            const code = codeSnippet || `# Search similar documents
import requests

query = "${query}"
query_embedding = generate_embedding(query)

# Perform vector search
response = requests.get(
    'http://localhost:8108/collections/typesense-demo/documents/search',
    headers={'X-TYPESENSE-API-KEY': 'your-api-key'},
    params={
        'q': '*',
        'vector_query': f'embedding:([{",".join(map(str, query_embedding))}], k:5)',
        'exclude_fields': 'embedding'
    }
)

results = response.json()
print(f"Found {results['found']} results")`;

            document.getElementById('searchCode').textContent = code;
            Prism.highlightElement(document.getElementById('searchCode'));
        }

        function updateJsonOutput(rawResponse) {
            document.getElementById('jsonOutput').textContent = JSON.stringify(rawResponse, null, 2);
        }

        async function listAllDocuments() {
            try {
                const response = await fetch('/api/typesense-gemma/list', {
                    method: 'GET'
                });

                const data = await response.json();

                if (data.success) {
                    const section = document.getElementById('allDocsSection');
                    const list = document.getElementById('allDocsList');

                    if (data.documents.length === 0) {
                        list.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">No documents found in collection. Please index some documents first.</p>';
                    } else {
                        list.innerHTML = `
                            <p style="margin-bottom: 16px; color: var(--text-secondary);">
                                <strong>Total:</strong> ${data.total} documents
                            </p>
                            ${data.documents.map((doc, index) => `
                                <div class="result-card">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                        <span style="background: var(--primary); color: white; padding: 4px 12px; border-radius: 16px; font-weight: 700; font-size: 0.9em;">
                                            #${index + 1}
                                        </span>
                                        <span style="font-family: monospace; font-size: 0.85em; color: var(--text-secondary);">
                                            ID: ${doc.id}
                                        </span>
                                    </div>
                                    <div class="result-text">${doc.text}</div>
                                </div>
                            `).join('')}
                        `;
                    }

                    section.style.display = 'block';
                    section.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // Enable search on Enter key
        document.getElementById('queryInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchDocuments();
            }
        });
    </script>
</body>
</html>
